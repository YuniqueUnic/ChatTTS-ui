<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatTTS WebUI & API - v{{version}}</title>
    <link href="/static/js/bootstrap.min.css" rel="stylesheet">
    <style>
        /* === å…¨å±€é‡ç½® === */
        :root {
            --border-color: #000;
            --border-width: 3px;
            --shadow-offset: 5px;
            --bg-color: #e0e7ff;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: #000;
            height: 100vh;
            overflow: hidden; /* ç¦æ­¢ body æ»šåŠ¨ */
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* === å¸ƒå±€æ ¸å¿ƒ (CSS Grid) === */
        .app-container {
            padding: 15px 25px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-bar {
            flex: 0 0 auto;
            margin-bottom: 20px;
            background: #fff;
            border: var(--border-width) solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-grid {
            flex: 1;
            display: grid;
            /* è°ƒæ•´æ¯”ä¾‹ï¼šå·¦ä¾§æ›´ç´§å‡‘ï¼Œä¸­é—´æ›´å®½æ•ï¼Œå³ä¾§é€‚ä¸­ */
            grid-template-columns: 280px 1fr 340px;
            gap: 25px;
            min-height: 0; /* å…³é”®ï¼šå…è®¸å­å…ƒç´ æ”¶ç¼© */
        }

        /* === å“åº”å¼å¸ƒå±€ (Mobile) === */
        @media (max-width: 1000px) {
            body { overflow: auto; height: auto; }
            .app-container { height: auto; display: block; padding: 10px; }
            
            .main-grid {
                display: flex;
                flex-direction: column;
                gap: 30px;
                height: auto;
            }

            /* åˆ©ç”¨ Order å±æ€§è°ƒæ•´æ˜¾ç¤ºé¡ºåº */
            .config-col { order: 2; } /* Config æ’ç¬¬2 */
            .main-col   { order: 1; } /* Editor æ’ç¬¬1 */
            .result-col { order: 3; } /* Result æ’ç¬¬3 */

            .panel-column {
                height: auto !important;
                max-height: none !important; /* å–æ¶ˆé«˜åº¦é™åˆ¶ */
                overflow: visible !important;
            }
            
            /* æ‰‹æœºä¸Šæ–‡æœ¬æ¡†å®šé«˜ */
            #text-input { min-height: 250px; }
        }

        /* === é¢æ¿æ ·å¼ === */
        .panel-column {
            background: #fff;
            border: var(--border-width) solid #000;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 #000;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .panel-header {
            padding: 12px 18px;
            border-bottom: var(--border-width) solid #000;
            font-weight: 900;
            font-size: 1.1rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            letter-spacing: 1px;
        }

        .panel-body {
            padding: 20px; /* å¢åŠ å†…è¾¹è· */
            overflow-y: auto;
            flex: 1;
        }

        /* é¢æ¿é…è‰² */
        .header-config { background-color: #a5f3fc; }
        .header-main   { background-color: #ff90e8; }
        .header-result { background-color: #fde047; }

        /* === æ§ä»¶ä¼˜åŒ– === */
        .section-label {
            font-size: 0.8rem;
            font-weight: 800;
            color: #444;
            text-transform: uppercase;
            margin: 20px 0 10px 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .section-label:first-child { margin-top: 0; }

        .form-control, .form-select {
            border: 2px solid #000 !important;
            border-radius: 0 !important;
            font-weight: 600;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.05);
            padding: 10px; /* å¢åŠ å†…è¡¬ */
        }
        .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: 4px 4px 0 rgba(0,0,0,1);
            background: #fff;
            border-color: #000;
        }

        /* æ–‡æœ¬æ¡†å……æ»¡å‰©ä½™ç©ºé—´ */
        textarea#text-input { 
            resize: none; 
            font-size: 1.1rem; 
            line-height: 1.6;
            padding: 15px;
            width: 100%; /* ç¡®ä¿å æ»¡å®½åº¦ */
        }

        /* === æŒ‰é’® === */
        .btn {
            border: 2px solid #000;
            border-radius: 0;
            font-weight: 800;
            text-transform: uppercase;
            position: relative;
            padding: 8px 16px;
        }
        .btn:hover { filter: brightness(1.05); background-color: #f0f0f0; }
        .btn:active { filter: brightness(0.95); }

        .btn-main {
            background: #000;
            color: #fff;
            width: 100%;
            padding: 18px; /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
            font-size: 1.3rem;
            letter-spacing: 2px;
            box-shadow: 4px 4px 0 #555;
            margin-top: 10px;
        }
        .btn-main:hover { color: #fde047; background: #222; box-shadow: 6px 6px 0 #555; }

        .btn-tag {
            background: #fff;
            font-size: 0.85rem;
            padding: 6px 10px;
            margin: 0 6px 6px 0;
            box-shadow: 3px 3px 0 #ddd;
            border-width: 2px;
        }
        .btn-tag:hover { background: #fde047; box-shadow: 3px 3px 0 #000; transform:translate(-1px,-1px); }

        /* === æ»‘å— === */
        input[type=range] {
            width: 100%;
            height: 25px; /* å¢åŠ é«˜åº¦ä¾¿äºç‚¹å‡» */
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 10px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #000;
            border-radius: 0;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            background: #ff90e8;
            border: 2px solid #000;
            -webkit-appearance: none;
            margin-top: -8px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        /* === ç»“æœåˆ—è¡¨ === */
        .audio-item {
            border: 2px solid #000;
            background: #fff;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 4px 4px 0 #ddd;
            transition: all 0.2s;
        }
        .audio-item:hover { box-shadow: 6px 6px 0 #000; transform: translateX(-2px); }

        /* === æ»šåŠ¨æ¡ === */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f5f5f5; border-left: 2px solid #000; }
        ::-webkit-scrollbar-thumb { background: #000; border: 2px solid #fff; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* === ä¸Šä¼ æŒ‰é’®ä¿®å¤ === */
        #upload-btn { position: relative; overflow: hidden; }
        #file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:10; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-bar">
        <div class="d-flex align-items-center gap-3">
            <h1 class="m-0" style="font-weight:900; font-size:1.8rem;">CHAT_TTS <span style="color:#ff90e8">UI</span></h1>
            <span class="badge bg-warning text-dark border border-dark rounded-0 p-2">v{{version}}</span>
        </div>
        <a href="https://github.com/jianchang512/chatTTS-ui" target="_blank" class="btn btn-light fw-bold">GITHUB</a>
    </div>

    <div class="main-grid">
        
        <!-- 1. å·¦ä¾§ï¼šé…ç½® (Config) -->
        <div class="panel-column config-col">
            <div class="panel-header header-config">
                <span>é…ç½®å‚æ•°</span><span>âš™ï¸</span>
            </div>
            <div class="panel-body">
                <div class="section-label">åŸºç¡€è®¾ç½®</div>
                <select id="voice" class="form-select mb-3">
                    {% for speaker in speakers %}
                    <option value="{{speaker}}">{{speaker}}</option>
                    {% endfor %}
                </select>
                <div class="row g-3 mb-3">
                    <div class="col-6"><input id="custom_voice" type="number" class="form-control" placeholder="è‡ªå®šä¹‰éŸ³è‰²"></div>
                    <div class="col-6"><input id="text_seed" type="number" class="form-control" value="42" placeholder="Seed"></div>
                </div>

                <div class="section-label">æ¨¡å‹å¾®è°ƒ</div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between fw-bold mb-1"><span>è¯­é€Ÿ Speed</span><span class="badge bg-dark rounded-0" id="val-speed">5</span></div>
                    <input type="range" id="speed" min="1" max="9" value="5" oninput="document.getElementById('val-speed').innerText=this.value">
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between fw-bold mb-1"><span>æ¸©åº¦ Temp</span><span class="badge bg-dark rounded-0" id="val-temp">0.1</span></div>
                    <input type="range" id="temperature" min="0.00001" max="1.0" step="0.00001" value="0.1" oninput="document.getElementById('val-temp').innerText=this.value">
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div class="d-flex justify-content-between fw-bold mb-1"><span>Top P</span><span class="small" id="val-topp">0.7</span></div>
                        <input type="range" id="top_p" min="0.001" max="0.9" step="0.05" value="0.7" oninput="document.getElementById('val-topp').innerText=this.value">
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between fw-bold mb-1"><span>Top K</span><span class="small" id="val-topk">20</span></div>
                        <input type="range" id="top_k" min="1" max="20" value="20" oninput="document.getElementById('val-topk').innerText=this.value">
                    </div>
                </div>

                <div class="section-label">Prompt & é«˜çº§</div>
                <input id="prompt" class="form-control mb-3" value="[break_6]" placeholder="Prompt...">
                
                <button class="btn w-100 border-dark bg-light text-start py-2" type="button" data-bs-toggle="collapse" data-bs-target="#advConfig">
                    â–¼ å±•å¼€é«˜çº§é€‰é¡¹
                </button>
                <div class="collapse" id="advConfig">
                    <div class="card card-body border-dark rounded-0 p-3 bg-light mt-2">
                        <div class="row g-3 mb-2">
                            <div class="col-6"><label class="small fw-bold">åˆ†ç‰‡é•¿</label><input id="segment_len" type="number" class="form-control" value="0"></div>
                            <div class="col-6"><label class="small fw-bold">åˆ†ç‰‡ç§’</label><input id="segment_seconds" type="number" class="form-control" value="0"></div>
                            <div class="col-6"><label class="small fw-bold">Infer</label><input id="infer_max_new_token" type="number" class="form-control" value="2048"></div>
                            <div class="col-6"><label class="small fw-bold">Refine</label><input id="refine_max_new_token" type="number" class="form-control" value="384"></div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input border-dark" id="skip_refine" checked>
                            <label class="form-check-label fw-bold" for="skip_refine">è·³è¿‡ Refine Text</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. ä¸­é—´ï¼šä¸»æ§ (Main) -->
        <div class="panel-column main-col">
            <div class="panel-header header-main">
                <span>åˆ›ä½œä¸­å¿ƒ</span><span>ğŸ“</span>
            </div>
            <div class="panel-body d-flex flex-column">
                <!-- æ–‡æœ¬æ¡†è‡ªåŠ¨æ’‘æ»¡å‰©ä½™é«˜åº¦ -->
                <textarea id="text-input" class="form-control flex-grow-1 mb-4 w-100" placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...&#10;å»ºè®®æ¯è¡Œä¸€å¥..."></textarea>

                <div class="section-label mt-0">å¿«æ·æ§åˆ¶ç¬¦</div>
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <button class="btn btn-tag tts-token-btn" data-token="[laugh]">[laugh]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[uv_break]">[uv_break]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[oral_2]">[oral_2]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[laugh_0]">[laugh_0]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[break_6]">[break_6]</button>
                </div>

                <div class="section-label">è¯­æ°”é¢„è®¾</div>
                <div class="d-flex gap-3 mb-4">
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-3" data-prompt="[oral_2][laugh_0][break_6]">ğŸ˜Š èŠå¤©</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-3" data-prompt="[oral_0][break_4]">ğŸ™ï¸ æ’­éŸ³</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-3" data-prompt="[oral_3][laugh_1][break_3]">ğŸ­ å¤¸å¼ </button>
                </div>

                <button id="submit-btn" class="btn btn-main mb-3">âš¡ ç«‹å³ç”ŸæˆéŸ³é¢‘</button>
                
                <div class="d-flex gap-3 mt-3">
                    <button id="upload-btn" class="btn btn-light flex-fill border-dark py-2 fw-bold">
                        ğŸ“‚ å¯¼å…¥ TXT
                        <input type="file" id="file-input" accept=".txt">
                    </button>
                    <button id="clear-btn" class="btn btn-danger flex-fill border-dark py-2 fw-bold" style="background:#ff4d4d; color:white;">
                        ğŸ—‘ï¸ æ¸…ç©º
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. å³ä¾§ï¼šç»“æœ (Results) -->
        <div class="panel-column result-col">
            <div class="panel-header header-result">
                <span>ç”Ÿæˆç»“æœ</span><span>ğŸµ</span>
            </div>
            <div class="panel-body" id="audio-container">
                <div class="text-center text-muted mt-5" id="empty-state">
                    <div style="font-size:4rem; opacity:0.15;">âˆ…</div>
                    <div class="fs-5 mt-2">æš‚æ— ç”Ÿæˆè®°å½•</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    function insertToken($textarea, token) {
        var el = $textarea.get(0);
        if (!el) return;
        var start = el.selectionStart || 0;
        var end = el.selectionEnd || 0;
        var value = el.value;
        el.value = value.substring(0, start) + token + value.substring(end);
        el.focus();
        el.selectionStart = el.selectionEnd = start + token.length;
    }

    function appendAudioItem(audio, autoPlay, jsCode, $container) {
        $('#empty-state').remove();
        var pos = audio.filename.lastIndexOf('/') + 1;
        var filename = audio.filename.substr(pos);
        var count = $('#audio-container').find('.audio-item').length + 1;
        var badge = '';
        if (audio.is_merged === 1) badge = '<span class="badge bg-success text-dark rounded-0 ms-1">åˆå¹¶</span>';
        else if (audio.part_index) badge = '<span class="badge bg-secondary text-dark rounded-0 ms-1">Part ' + audio.part_index + '</span>';
        
        var durationText = (audio.audio_duration && audio.audio_duration > 0) ? ' | ' + audio.audio_duration + 's' : '';
        var autoplayAttr = autoPlay ? ' autoplay' : '';
        jsCode = jsCode || '';
        $container = $container || $('#audio-container');

        var html = `
        <div class="audio-item" data-filename="${filename}">
            <div class="d-flex justify-content-between align-items-center border-bottom border-dark pb-2 mb-2">
                <div class="fw-bold text-truncate" style="max-width:85%">#${count} ${filename} ${badge}</div>
                <button onclick="deleteWavItem(this)" class="btn btn-link text-danger p-0 fw-bold text-decoration-none fs-4" style="line-height:1">&times;</button>
            </div>
            <audio controls${autoplayAttr} src="${audio.url}" style="width:100%; height:32px;"></audio>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="small text-muted">${audio.inference_time}s ${durationText}</div>
                <div class="d-flex gap-2">
                    <button class="btn btn-info btn-sm py-1 px-2 rounded-0 border-dark text-white fw-bold show-js-btn" data-js-code="${encodeURIComponent(jsCode)}">API</button>
                    <a href="${audio.url}" download="${filename}" class="btn btn-success btn-sm py-1 px-2 rounded-0 border-dark fw-bold">ä¸‹è½½</a>
                </div>
            </div>
            <div class="mt-2 bg-dark text-light d-none code-container p-3 small text-break border border-dark font-monospace"></div>
        </div>`;
        $container.prepend(html);
    }

    function appendAudioBatch(audioList, data) {
        if (!audioList || audioList.length === 0) return;
        var batchIndex = $('#audio-container').find('.audio-batch').length + 1;
        var batchId = 'batch-' + Date.now();
        var html = `
        <div class="audio-batch mb-4" data-batch-id="${batchId}">
            <div class="bg-warning border border-dark p-2 px-3 d-flex justify-content-between align-items-center border-bottom-0">
                <span class="fw-bold">BATCH #${batchIndex} [${audioList.length}]</span>
                <button class="btn btn-dark btn-sm py-0 rounded-0 fw-bold delete-batch-btn">DEL ALL</button>
            </div>
            <div class="batch-body p-2 border border-dark bg-white"></div>
        </div>`;
        $('#audio-container').prepend(html);
        var $body = $('#audio-container').find('.audio-batch').first().find('.batch-body');
        
        // Construct Python API Code Example
        var pythonCode = 
`import requests
import json

# API Endpoint
url = "http://${location.host}/tts"

# Parameters
data = ${JSON.stringify(data, null, 4)}

# Send Request
try:
    response = requests.post(url, data=data)
    if response.status_code == 200:
        result = response.json()
        print(json.dumps(result, indent=4, ensure_ascii=False))
        # Output Format:
        # {
        #     "code": 0, 
        #     "msg": "ok", 
        #     "audio_files": [
        #         {"filename": "...", "url": "...", "inference_time": ...}
        #     ]
        # }
    else:
        print(f"Error: {response.status_code} - {response.text}")
except Exception as e:
    print(f"Request Failed: {e}")
`;
        
        audioList.forEach(function(audio) {
            appendAudioItem(audio, true, pythonCode, $body);
        });
    }

    function loadAudioList() {
        $.ajax({
            url: '/list_wavs',
            type: 'GET',
            success: function(response) {
                if (response.code === 0 && response.audio_files && response.audio_files.length > 0) {
                    $('#audio-container').empty();
                    response.audio_files.forEach(function(audio) { appendAudioItem(audio, false, ''); });
                }
            }
        });
    }
    loadAudioList();

    $('#submit-btn').click(function() {
        var text = $('#text-input').val().trim();
        if (!text) { layer.msg('è¯·å…ˆè¾“å…¥æ–‡æœ¬'); return; }
        var index = layer.load(1);
        
        var data = {
            text: text,
            prompt: $('#prompt').val(),
            voice: $('#voice').val(),
            speed: parseInt($('#speed').val()),
            temperature: parseFloat($('#temperature').val()),
            top_p: parseFloat($('#top_p').val()),
            top_k: parseInt($('#top_k').val()),
            refine_max_new_token: parseInt($('#refine_max_new_token').val()),
            infer_max_new_token: parseInt($('#infer_max_new_token').val()),
            text_seed: parseInt($('#text_seed').val()),
            skip_refine: $('#skip_refine').prop('checked') ? 1 : 0,
            is_stream: 0,
            custom_voice: $('#custom_voice').val() ? parseInt($('#custom_voice').val()) : 0,
            segment_len: parseInt($('#segment_len').val() || 0),
            segment_seconds: parseFloat($('#segment_seconds').val() || 0),
            split: 1
        };

        $.ajax({
            url: '/tts',
            type: 'POST',
            data: data,
            success: function(res) {
                layer.close(index);
                if (res.code === 0 && res.audio_files) { appendAudioBatch(res.audio_files, data); }
                else { layer.alert(res.msg || 'ç”Ÿæˆå¤±è´¥', {title:false}); }
            },
            error: function(e) { layer.close(index); layer.alert('é”™è¯¯', {title:false}); }
        });
    });

    $(document).on('click', '.show-js-btn', function() {
        var box = $(this).closest('.audio-item').find('.code-container');
        box.toggleClass('d-none');
        if(!box.hasClass('d-none')) box.html('<pre style="margin:0;color:#a5f3fc;white-space:pre-wrap;">'+decodeURIComponent($(this).data('js-code'))+'</pre>');
    });

    $(document).on('click', '.tts-token-btn', function() { insertToken($('#text-input'), $(this).data('token')); });
    $(document).on('click', '.tone-preset-btn', function() { 
        if($(this).data('prompt')) $('#prompt').val($(this).data('prompt')); 
    });

    $('#upload-btn').click(function(){ $('#file-input').click(); });
    $('#file-input').change(function(e){
        var f = e.target.files[0];
        if(f) {
            var r = new FileReader();
            r.onload = function(e) { $('#text-input').val(e.target.result); };
            r.readAsText(f, 'UTF-8');
        }
    });

    $('#clear-btn').click(function() {
        layer.confirm('ç¡®å®šæ¸…ç©º?', {title:false, btn:['æ˜¯','å¦']}, function(){
            $.ajax({url:'/clear_wavs', type:'POST', success:function(res){
                if(res.code===0) { $('#audio-container').html('<div class="text-center text-muted mt-5" id="empty-state"><div style="font-size:4rem;opacity:0.15;">âˆ…</div><div class="fs-5 mt-2">æš‚æ— ç”Ÿæˆè®°å½•</div></div>'); layer.msg('å·²æ¸…ç©º'); }
            }});
        });
    });

    $(document).on('click', '.delete-batch-btn', function() {
        var $b = $(this).closest('.audio-batch');
        var fs = [];
        $b.find('.audio-item').each(function(){ fs.push($(this).data('filename')); });
        if(!fs.length) { $b.remove(); return; }
        layer.confirm('åˆ é™¤æœ¬æ‰¹æ¬¡?', {title:false}, function(){
            $.ajax({url:'/delete_wavs_batch', type:'POST', data:{filenames:fs.join(',')}, success:function(res){
                if(res.code===0) { $b.remove(); layer.msg('å·²åˆ é™¤'); }
            }});
        });
    });

    window.deleteWavItem = function(btn) {
        var $i = $(btn).closest('.audio-item');
        var f = $i.data('filename');
        if(!f) return;
        $.ajax({url:'/delete_wav', type:'POST', data:{filename:f}, success:function(res){
            if(res.code===0) $i.remove();
        }});
    };
});
</script>
</body>
</html>
