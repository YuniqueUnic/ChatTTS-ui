<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatTTS WebUI & API - v{{version}}</title>
    <link href="/static/js/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --border-color: #000;
            --border-width: 3px;
            --shadow-offset: 5px;
            --bg-color: #e0e7ff;
            --col-config: 340px;
            --col-result: 340px;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: #000;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .app-container { padding: 15px 25px; height: 100vh; display: flex; flex-direction: column; }

        .header-bar {
            flex: 0 0 auto; margin-bottom: 15px; background: #fff;
            border: var(--border-width) solid #000; box-shadow: 4px 4px 0 #000;
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
        }

        .main-grid { flex: 1; display: flex; gap: 0; min-height: 0; }

        .panel-column {
            background: #fff; border: var(--border-width) solid #000;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 #000;
            display: flex; flex-direction: column; height: 100%; overflow: hidden; min-width: 200px;
        }
        .config-col { width: var(--col-config); flex-shrink: 0; }
        .main-col { flex: 1; min-width: 300px; }
        .result-col { width: var(--col-result); flex-shrink: 0; }

        .splitter {
            width: 8px; cursor: col-resize; flex-shrink: 0; transition: background 0.2s;
            background: linear-gradient(90deg, #ccc 1px, transparent 1px, transparent 3px, #ccc 3px);
        }
        .splitter:hover, .splitter.dragging { background: #ff90e8; }

        @media (max-width: 1000px) {
            body { overflow: auto; height: auto; }
            .app-container { height: auto; display: block; padding: 10px; }
            .main-grid { display: flex; flex-direction: column; gap: 20px; height: auto; }
            .config-col, .main-col, .result-col { width: 100% !important; height: auto !important; }
            /* Mobile order: workspace (main) -> config -> result */
            .main-col { order: 1; }
            .config-col { order: 2; }
            .result-col { order: 3; }
            .splitter { display: none; }
            .panel-column { height: auto !important; max-height: none !important; overflow: visible !important; }
            #text-input { min-height: 250px; }
        }

        .panel-header {
            padding: 10px 15px; border-bottom: var(--border-width) solid #000;
            font-weight: 900; font-size: 1rem; text-transform: uppercase;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .panel-body { padding: 15px; overflow-y: auto; flex: 1; }

        .header-config { background-color: #a5f3fc; }
        .header-main   { background-color: #ff90e8; }
        .header-result { background-color: #fde047; }

        .section-label {
            font-size: 0.75rem; font-weight: 800; color: #444; text-transform: uppercase;
            margin: 15px 0 8px 0; border-bottom: 2px solid #eee; padding-bottom: 4px;
        }
        .section-label:first-child { margin-top: 0; }

        .form-control, .form-select {
            border: 2px solid #000 !important; border-radius: 0 !important;
            font-weight: 600; padding: 8px; font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            outline: none; box-shadow: 3px 3px 0 rgba(0,0,0,0.8); background: #fff; border-color: #000;
        }

        .editor-wrap { display: flex; flex: 1; border: 2px solid #000; background: #fff; min-height: 150px; }
        .line-numbers {
            background: #f5f5f5; border-right: 2px solid #000; padding: 10px 8px;
            text-align: right; font-size: 0.9rem; line-height: 1.5; color: #888; user-select: none; overflow: hidden;
        }
        .editor-wrap textarea {
            flex: 1; border: none !important; resize: none; font-size: 0.95rem;
            line-height: 1.5; padding: 10px; outline: none; font-family: inherit;
        }

        .btn { border: 2px solid #000; border-radius: 0; font-weight: 800; text-transform: uppercase; padding: 6px 12px; font-size: 0.85rem; }
        .btn:hover { filter: brightness(1.05); }
        .btn:active { filter: brightness(0.95); }

        .btn-main { background: #000; color: #fff; width: 100%; padding: 14px; font-size: 1.1rem; letter-spacing: 1px; box-shadow: 4px 4px 0 #555; }
        .btn-main:hover { color: #fde047; background: #222; }

        .btn-tag { background: #fff; font-size: 0.8rem; padding: 4px 8px; margin: 0 4px 4px 0; box-shadow: 2px 2px 0 #ddd; }
        .btn-tag:hover { background: #fde047; box-shadow: 2px 2px 0 #000; }

        input[type=range] { width: 100%; height: 20px; -webkit-appearance: none; background: transparent; cursor: pointer; margin: 5px 0; }
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #000; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; background: #ff90e8; border: 2px solid #000; -webkit-appearance: none; margin-top: -6px; }

        .audio-item { border: 2px solid #000; background: #fff; margin-bottom: 10px; padding: 10px; box-shadow: 3px 3px 0 #ddd; font-size: 0.85rem; position: relative; }
        .audio-item:hover { box-shadow: 4px 4px 0 #000; }
        .audio-item.selected { background: #fef3c7; border-color: #f59e0b; }
        .audio-item .item-checkbox { position: absolute; top: 8px; left: 8px; width: 18px; height: 18px; cursor: pointer; accent-color: #000; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f5; }
        ::-webkit-scrollbar-thumb { background: #000; }

        .tip-icon {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%; background: #000; color: #fff;
            font-size: 10px; font-weight: bold; cursor: help; margin-left: 4px; vertical-align: middle;
        }
        .input-label { font-size: 0.7rem; font-weight: 700; color: #555; margin-bottom: 2px; display: block; }

        #upload-btn { position: relative; overflow: hidden; }
        #file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:10; }

        .github-links a { margin-left: 10px; font-size: 0.85rem; font-weight: 700; color: #000; text-decoration: none; padding: 6px 10px; border: 2px solid #000; background: #fff; }
        .github-links a:hover { background: #fde047; }

        /* Batch toolbar */
        .batch-toolbar { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 10px; padding: 8px; background: #f5f5f5; border: 2px solid #000; }
        .batch-toolbar .btn { font-size: 0.7rem; padding: 4px 8px; }
        .batch-toolbar .select-count { font-size: 0.75rem; font-weight: 700; margin-left: auto; align-self: center; }

        /* Responsive download button */
        .dl-btn { min-width: 32px; }
        .dl-btn .full-text { display: none; }
        @media (min-width: 1200px) { .dl-btn .full-text { display: inline; } .dl-btn .short-text { display: none; } }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-bar">
        <div class="d-flex align-items-center gap-2">
            <h1 class="m-0" style="font-weight:900; font-size:1.5rem;">CHAT_TTS <span style="color:#ff90e8">UI</span></h1>
            <span class="badge bg-warning text-dark border border-dark rounded-0 p-1" style="font-size:0.7rem;">v{{version}}</span>
        </div>
        <div class="github-links">
            <a href="https://github.com/jianchang512/chatTTS-ui" target="_blank">ChatTTS-UI</a>
            <a href="https://github.com/2noise/ChatTTS" target="_blank">ChatTTS</a>
            <a href="javascript:void(0)" id="save-workspace-btn">ä¿å­˜</a>
            <a href="/?lang=zh">ä¸­æ–‡</a>
            <a href="/?lang=en">EN</a>
        </div>
    </div>

    <div class="main-grid">
        <!-- Config Column -->
        <div class="panel-column config-col" id="config-col">
            <div class="panel-header header-config"><span>é…ç½®</span><span>âš™ï¸</span></div>
            <div class="panel-body">
                <div class="section-label">éŸ³è‰²è®¾ç½®</div>
                <select id="voice" class="form-select mb-2">
                    {% for speaker in speakers %}
                    <option value="{{speaker}}">{{speaker}}</option>
                    {% endfor %}
                </select>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="input-label">è‡ªå®šä¹‰éŸ³è‰²ID <span class="tip-icon" title="å¡«å†™åå°†å¿½ç•¥å·¦ä¾§éŸ³è‰²é€‰æ‹©ï¼Œä»¥è¯¥å€¼è·å–éŸ³è‰²ã€‚å¦‚ 2000, 8000 ç­‰">?</span></label>
                        <input id="custom_voice" type="number" class="form-control" placeholder="å¦‚ 3000">
                    </div>
                    <div class="col-6">
                        <label class="input-label">Text Seed <span class="tip-icon" title="æ–‡æœ¬éšæœºç§å­ï¼Œå½±å“ç”Ÿæˆç»“æœçš„éšæœºæ€§">?</span></label>
                        <input id="text_seed" type="number" class="form-control" value="42">
                    </div>
                </div>

                <div class="section-label">æ¨¡å‹å‚æ•°</div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="input-label mb-0">è¯­é€Ÿ Speed <span class="tip-icon" title="æ§åˆ¶è¯­é€Ÿï¼Œ1æœ€æ…¢ï¼Œ9æœ€å¿«ï¼Œé»˜è®¤5">?</span></span>
                        <span class="badge bg-dark rounded-0" id="val-speed">5</span>
                    </div>
                    <input type="range" id="speed" min="1" max="9" value="5" oninput="document.getElementById('val-speed').innerText=this.value">
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="input-label mb-0">æ¸©åº¦ Temp <span class="tip-icon" title="é‡‡æ ·æ¸©åº¦ï¼Œè¶Šé«˜éšæœºæ€§è¶Šå¤§ï¼Œè¶Šä½è¶Šç¨³å®š">?</span></span>
                        <span class="badge bg-dark rounded-0" id="val-temp">0.1</span>
                    </div>
                    <input type="range" id="temperature" min="0.00001" max="1.0" step="0.05" value="0.1" oninput="document.getElementById('val-temp').innerText=parseFloat(this.value).toFixed(2)">
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="input-label mb-0">Top P <span class="tip-icon" title="æ ¸é‡‡æ ·å‚æ•°ï¼Œæ§åˆ¶ç”Ÿæˆå¤šæ ·æ€§">?</span></span>
                            <span class="small" id="val-topp">0.7</span>
                        </div>
                        <input type="range" id="top_p" min="0.1" max="0.9" step="0.05" value="0.7" oninput="document.getElementById('val-topp').innerText=parseFloat(this.value).toFixed(2)">
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="input-label mb-0">Top K <span class="tip-icon" title="Top-Ké‡‡æ ·ï¼Œé™åˆ¶æ¯æ­¥å€™é€‰tokenæ•°é‡">?</span></span>
                            <span class="small" id="val-topk">20</span>
                        </div>
                        <input type="range" id="top_k" min="1" max="20" value="20" oninput="document.getElementById('val-topk').innerText=this.value">
                    </div>
                </div>

                <div class="section-label">Prompt & é«˜çº§</div>
                <label class="input-label">Refine Prompt <span class="tip-icon" title="æ§åˆ¶è¯­æ°”çš„promptï¼Œå¦‚ [oral_2][laugh_0][break_6]ã€‚oralæ§åˆ¶å£è¯­åŒ–ç¨‹åº¦(0-9)ï¼Œlaughæ§åˆ¶ç¬‘å£°(0-2)ï¼Œbreakæ§åˆ¶åœé¡¿(0-7)">?</span></label>
                <textarea id="prompt" class="form-control mb-2" rows="2" style="font-size:0.85rem;">[oral_2][laugh_0][break_6]</textarea>
                
                <button class="btn w-100 border-dark bg-light text-start py-2" type="button" data-bs-toggle="collapse" data-bs-target="#advConfig">â–¼ é«˜çº§é€‰é¡¹</button>
                <div class="collapse" id="advConfig">
                    <div class="card card-body border-dark rounded-0 p-2 bg-light mt-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="input-label">åˆ†ç‰‡é•¿åº¦ <span class="tip-icon" title="å•æ®µæœ€å¤§å­—ç¬¦æ•°ï¼Œ0=è‡ªåŠ¨åˆ†ç‰‡">?</span></label>
                                <input id="segment_len" type="number" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="input-label">åˆ†ç‰‡æ—¶é•¿(ç§’) <span class="tip-icon" title="æ¯æ®µç›®æ ‡æ—¶é•¿(ç§’)ï¼Œå¤§äº0æ—¶ä¼˜å…ˆç”Ÿæ•ˆ">?</span></label>
                                <input id="segment_seconds" type="number" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="input-label">Infer Token <span class="tip-icon" title="æ¨ç†æœ€å¤§tokenæ•°ï¼Œé»˜è®¤2048">?</span></label>
                                <input id="infer_max_new_token" type="number" class="form-control" value="2048">
                            </div>
                            <div class="col-6">
                                <label class="input-label">Refine Token <span class="tip-icon" title="Refine textæœ€å¤§tokenæ•°ï¼Œé»˜è®¤384">?</span></label>
                                <input id="refine_max_new_token" type="number" class="form-control" value="384">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input border-dark" id="skip_refine" checked>
                            <label class="form-check-label small fw-bold" for="skip_refine">è·³è¿‡ Refine Text <span class="tip-icon" title="å¦‚æœæ–‡æœ¬ä¸­å·²åŠ å…¥æ§åˆ¶ç¬¦æˆ–æ•ˆæœè¾ƒå·®ï¼Œå¯é€‰ä¸­è·³è¿‡">?</span></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="splitter" id="splitter1"></div>

        <!-- Main Column -->
        <div class="panel-column main-col" id="main-col">
            <div class="panel-header header-main"><span>å·¥ä½œåŒº</span><span>ğŸ“</span></div>
            <div class="panel-body d-flex flex-column">
                <div class="editor-wrap mb-3">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <textarea id="text-input" placeholder="åœ¨æ­¤è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬...&#10;å»ºè®®æ¯è¡Œä¸€å¥..."></textarea>
                </div>

                <div class="d-flex align-items-center justify-content-between mb-1">
                    <div class="section-label mt-0 mb-0" style="border:none;">å¿«æ·æ§åˆ¶ç¬¦ <span class="tip-icon" title="ç‚¹å‡»æ’å…¥æ§åˆ¶ç¬¦ã€‚[laugh]ç¬‘å£° [uv_break]åœé¡¿ã€‚å£è¯­åŒ–ä¸åœé¡¿å¼ºåº¦è¯·åœ¨ Refine Prompt ä¸­è®¾ç½® [oral_N][laugh_N][break_N]">?</span></div>
                    <button id="format-tokens-btn" class="btn btn-sm btn-light border-dark py-1 px-2" style="font-size:0.7rem;" title="æ ¼å¼åŒ–æ–‡æœ¬ä¸­çš„æ§åˆ¶ç¬¦ä¸æ–‡å­—é—´è·">âœ¨ Format</button>
                </div>
                <div class="d-flex flex-wrap mb-3">
                    <button class="btn btn-tag tts-token-btn" data-token="[laugh]">[laugh]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[uv_break]">[uv_break]</button>
                </div>

                <div class="section-label">è¯­æ°”é¢„è®¾</div>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_2][laugh_0][break_6]">ğŸ˜Š èŠå¤©</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_0][break_4]">ğŸ™ï¸ æ’­éŸ³</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_3][laugh_1][break_3]">ğŸ­ å¤¸å¼ </button>
                </div>

                <button id="submit-btn" class="btn btn-main mb-2">âš¡ ç«‹å³ç”Ÿæˆ</button>
                
                <button id="upload-btn" class="btn btn-light border-dark py-2 w-100">
                    ğŸ“‚ å¯¼å…¥TXTæ–‡ä»¶
                    <input type="file" id="file-input" accept=".txt">
                </button>
            </div>
        </div>

        <div class="splitter" id="splitter2"></div>

        <!-- Result Column -->
        <div class="panel-column result-col" id="result-col">
            <div class="panel-header header-result"><span>ç»“æœ</span><span>ğŸµ</span></div>
            <div class="panel-body">
                <div class="batch-toolbar" id="batch-toolbar" style="display:none;">
                    <button id="select-all-btn" class="btn btn-dark">å…¨é€‰</button>
                    <button id="deselect-all-btn" class="btn btn-light border-dark">å–æ¶ˆ</button>
                    <button id="delete-selected-btn" class="btn text-white" style="background:#dc3545;">åˆ é™¤é€‰ä¸­</button>
                    <button id="download-selected-btn" class="btn btn-success border-dark">ä¸‹è½½é€‰ä¸­</button>
                    <span class="select-count" id="select-count">0 é€‰ä¸­</span>
                </div>
                <div id="audio-container">
                    <div class="text-center text-muted mt-4" id="empty-state">
                        <div style="font-size:3rem; opacity:0.15;">âˆ…</div>
                        <div class="small">æš‚æ— ç”Ÿæˆè®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    var $textarea = $('#text-input'), $lineNums = $('#line-numbers');
    var LS_KEY = 'chattts_workspace_v1';
    var saveTimer = null;

    // === Line Numbers ===
    function updateLineNumbers() {
        var lines = $textarea.val().split('\n').length;
        var nums = [];
        for (var i = 1; i <= Math.max(lines, 1); i++) nums.push(i);
        $lineNums.html(nums.join('<br>'));
    }
    $textarea.on('input scroll', function() { updateLineNumbers(); $lineNums.scrollTop($textarea.scrollTop()); });
    updateLineNumbers();

    function collectWorkspaceState() {
        return {
            text: $textarea.val(),
            prompt: $('#prompt').val(),
            voice: $('#voice').val(),
            custom_voice: $('#custom_voice').val(),
            text_seed: $('#text_seed').val(),
            speed: $('#speed').val(),
            temperature: $('#temperature').val(),
            top_p: $('#top_p').val(),
            top_k: $('#top_k').val(),
            segment_len: $('#segment_len').val(),
            segment_seconds: $('#segment_seconds').val(),
            infer_max_new_token: $('#infer_max_new_token').val(),
            refine_max_new_token: $('#refine_max_new_token').val(),
            skip_refine: $('#skip_refine').prop('checked') ? 1 : 0,
        };
    }

    function applyWorkspaceState(st) {
        if (!st) return;
        if (typeof st.text === 'string') {
            $textarea.val(st.text);
        }
        if (st.prompt !== undefined) $('#prompt').val(st.prompt);
        if (st.voice !== undefined) $('#voice').val(st.voice);
        if (st.custom_voice !== undefined) $('#custom_voice').val(st.custom_voice);
        if (st.text_seed !== undefined) $('#text_seed').val(st.text_seed);
        if (st.speed !== undefined) {
            $('#speed').val(st.speed);
            $('#val-speed').text(st.speed);
        }
        if (st.temperature !== undefined) {
            $('#temperature').val(st.temperature);
            $('#val-temp').text(parseFloat(st.temperature).toFixed(2));
        }
        if (st.top_p !== undefined) {
            $('#top_p').val(st.top_p);
            $('#val-topp').text(parseFloat(st.top_p).toFixed(2));
        }
        if (st.top_k !== undefined) {
            $('#top_k').val(st.top_k);
            $('#val-topk').text(st.top_k);
        }
        if (st.segment_len !== undefined) $('#segment_len').val(st.segment_len);
        if (st.segment_seconds !== undefined) $('#segment_seconds').val(st.segment_seconds);
        if (st.infer_max_new_token !== undefined) $('#infer_max_new_token').val(st.infer_max_new_token);
        if (st.refine_max_new_token !== undefined) $('#refine_max_new_token').val(st.refine_max_new_token);
        if (st.skip_refine !== undefined) $('#skip_refine').prop('checked', !!st.skip_refine);
        updateLineNumbers();
    }

    function saveWorkspaceState(showToast) {
        if (!window.localStorage) {
            if (showToast) layer.msg('LocalStorage not available');
            return;
        }
        try {
            localStorage.setItem(LS_KEY, JSON.stringify(collectWorkspaceState()));
            if (showToast) layer.msg('å·²ä¿å­˜');
        } catch (e) {
            if (showToast) layer.msg('ä¿å­˜å¤±è´¥');
        }
    }

    function scheduleAutoSave() {
        if (!window.localStorage) return;
        clearTimeout(saveTimer);
        saveTimer = setTimeout(function() { saveWorkspaceState(false); }, 800);
    }

    if (window.localStorage) {
        try {
            var rawState = localStorage.getItem(LS_KEY);
            if (rawState) {
                applyWorkspaceState(JSON.parse(rawState));
            }
        } catch (e) {}
    }

    // === Splitter Resize ===
    function initSplitter(sid, leftId, rightId, minL, minR) {
        var $sp = $('#'+sid), $l = $('#'+leftId), $r = $('#'+rightId), drag = false;
        $sp.on('mousedown', function(e) {
            e.preventDefault(); drag = true; $sp.addClass('dragging');
            $(document).on('mousemove.sp', function(e) {
                if (!drag) return;
                var cL = $('.main-grid').offset().left, cW = $('.main-grid').width();
                if (sid === 'splitter1') { var nw = Math.max(minL, Math.min(e.pageX - cL, cW - minR - 350)); $l.css('width', nw+'px'); }
                else { var nw = Math.max(minR, Math.min(cL + cW - e.pageX, cW - minL - 350)); $r.css('width', nw+'px'); }
            });
            $(document).on('mouseup.sp', function() { drag = false; $sp.removeClass('dragging'); $(document).off('.sp'); });
        });
    }
    initSplitter('splitter1', 'config-col', 'main-col', 200, 250);
    initSplitter('splitter2', 'main-col', 'result-col', 250, 200);

    // === Smart Token Insert ===
    function insertToken($ta, token) {
        var el = $ta.get(0); if (!el) return;
        var start = el.selectionStart || 0, end = el.selectionEnd || start;
        var val = el.value, before = start > 0 ? val.charAt(start - 1) : '', after = end < val.length ? val.charAt(end) : '';
        var ins = token;
        // Add space before if needed
        if (start > 0 && !/[\s\[\]]/.test(before)) ins = ' ' + ins;
        // Add space after if there's content and not a token/space
        if (end < val.length && !/[\s\[]/.test(after)) ins = ins + ' ';
        el.value = val.substring(0, start) + ins + val.substring(end);
        el.focus();
        var np = start + ins.length;
        el.selectionStart = el.selectionEnd = np;
        updateLineNumbers();
    }

    // === Format Tokens ===
    function formatTokens(text) {
        // Normalize tokens on each line, but never modify user line breaks.
        var lines = text.split('\n');
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            line = line
                .replace(/([^\s\[\]])(\[(?:laugh|uv_break|lbreak|oral_\d|laugh_\d|break_\d)\])/g, '$1 $2')
                .replace(/(\[(?:laugh|uv_break|lbreak|oral_\d|laugh_\d|break_\d)\])([^\s\[\]\n])/g, '$1 $2')
                .replace(/ {2,}/g, ' ');
            lines[i] = line;
        }
        return lines.join('\n');
    }

    $('#format-tokens-btn').click(function() {
        var text = $textarea.val();
        var formatted = formatTokens(text);
        if (text !== formatted) {
            $textarea.val(formatted);
            updateLineNumbers();
            layer.msg('å·²æ ¼å¼åŒ–');
        } else {
            layer.msg('æ— éœ€æ ¼å¼åŒ–');
        }
    });

    // === Workspace Save / Restore bindings ===
    $textarea.on('input', scheduleAutoSave);
    $('#prompt, #voice, #custom_voice, #text_seed, #speed, #temperature, #top_p, #top_k, #segment_len, #segment_seconds, #infer_max_new_token, #refine_max_new_token')
        .on('change input', scheduleAutoSave);
    $('#skip_refine').on('change', scheduleAutoSave);

    $('#save-workspace-btn').click(function() {
        saveWorkspaceState(true);
    });

    // === Generate cURL code ===
    function escapeForCurl(val) {
        if (val === null || val === undefined) return '';
        var s = String(val);
        // è½¬ä¹‰åæ–œæ å’ŒåŒå¼•å·ï¼Œå¹¶æŠŠæ¢è¡ŒæŠ˜å ä¸º \n
        s = s.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\r?\n/g, '\\n');
        return s;
    }

    function buildCurlCode(data) {
        if (!data || Object.keys(data).length === 0) {
            return 'curl -X POST "http://' + location.host + '/tts" \\\n  -d "text=YOUR_TEXT" \\\n  -d "voice=VOICE_NAME"';
        }
        var parts = [];
        for (var k in data) {
            if (!data.hasOwnProperty(k)) continue;
            parts.push('-d "' + k + '=' + escapeForCurl(data[k]) + '"');
        }
        return 'curl -X POST "http://' + location.host + '/tts" \\\n  ' + parts.join(' \\\n  ');
    }

    // === Audio Item ===
    function appendAudioItem(audio, autoPlay, curlCode, $container) {
        $('#empty-state').remove();
        var pos = audio.filename.lastIndexOf('/') + 1;
        var fn = audio.filename.substr(pos);
        var cnt = $('#audio-container').find('.audio-item').length + 1;
        var badge = audio.is_merged === 1 ? '<span class="badge bg-success text-dark rounded-0 ms-1">åˆå¹¶</span>' : (audio.part_index ? '<span class="badge bg-secondary rounded-0 ms-1">P' + audio.part_index + '</span>' : '');
        var dur = (audio.audio_duration && audio.audio_duration > 0) ? ' | ' + audio.audio_duration + 's' : '';
        curlCode = curlCode || buildCurlCode(null);
        $container = $container || $('#audio-container');
        var src = audio.relative_url || audio.url;

        var html = `
        <div class="audio-item" data-filename="${fn}">
            <input type="checkbox" class="item-checkbox">
            <div class="d-flex justify-content-between align-items-center mb-1" style="padding-left:24px;">
                <div class="fw-bold text-truncate" style="max-width:75%; font-size:0.8rem;">#${cnt} ${fn}${badge}</div>
                <button onclick="deleteWavItem(this)" class="btn btn-link text-danger p-0" style="font-size:1.2rem; line-height:1;">&times;</button>
            </div>
            <audio controls${autoPlay ? ' autoplay' : ''} src="${src}" style="width:100%; height:28px;"></audio>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="text-muted" style="font-size:0.75rem;">${audio.inference_time || 0}s${dur}</div>
                <div class="d-flex gap-1">
                    <button class="btn btn-info btn-sm py-0 px-1 rounded-0 border-dark text-white show-curl-btn" style="font-size:0.7rem;" data-curl="${encodeURIComponent(curlCode)}">API</button>
                    <a href="${src}" download="${fn}" class="btn btn-success btn-sm py-0 px-1 rounded-0 border-dark dl-btn" style="font-size:0.7rem;"><span class="short-text">DL</span><span class="full-text">Download</span></a>
                </div>
            </div>
            <div class="mt-2 bg-dark text-light d-none curl-container p-2" style="font-size:0.7rem; word-break:break-all;"></div>
        </div>`;
        $container.prepend(html);
        updateBatchToolbar();
    }

    function appendAudioBatch(audioList, data) {
        if (!audioList || audioList.length === 0) return;
        var bIdx = $('#audio-container').find('.audio-batch').length + 1;
        var bId = 'batch-' + Date.now();
        var html = `
        <div class="audio-batch mb-3" data-batch-id="${bId}">
            <div class="bg-warning border border-dark p-1 px-2 d-flex justify-content-between align-items-center" style="font-size:0.85rem;">
                <span class="fw-bold">BATCH #${bIdx} [${audioList.length}]</span>
                <button class="btn btn-dark btn-sm py-0 px-1 rounded-0 delete-batch-btn" style="font-size:0.7rem;">åˆ é™¤æ‰¹æ¬¡</button>
            </div>
            <div class="batch-body p-1 border border-dark border-top-0 bg-white"></div>
        </div>`;
        $('#audio-container').prepend(html);
        var $body = $('#audio-container').find('.audio-batch').first().find('.batch-body');
        var curl = buildCurlCode(data);
        audioList.forEach(function(a) { appendAudioItem(a, false, curl, $body); });
    }

    function loadAudioList() {
        $.ajax({ url: '/list_wavs', type: 'GET', success: function(res) {
            if (res.code === 0 && res.audio_files && res.audio_files.length > 0) {
                $('#audio-container').empty();
                var ws = collectWorkspaceState();
                var curlDefault = buildCurlCode(ws);
                res.audio_files.forEach(function(a) { appendAudioItem(a, false, curlDefault, null); });
            }
            updateBatchToolbar();
        }});
    }
    loadAudioList();

    // === Batch Selection ===
    function updateBatchToolbar() {
        var total = $('#audio-container .audio-item').length;
        var sel = $('#audio-container .item-checkbox:checked').length;
        $('#batch-toolbar').toggle(total > 0);
        $('#select-count').text(sel + ' é€‰ä¸­');
    }

    $(document).on('change', '.item-checkbox', function() {
        $(this).closest('.audio-item').toggleClass('selected', this.checked);
        updateBatchToolbar();
    });

    $('#select-all-btn').click(function() {
        $('#audio-container .item-checkbox').prop('checked', true).closest('.audio-item').addClass('selected');
        updateBatchToolbar();
    });

    $('#deselect-all-btn').click(function() {
        $('#audio-container .item-checkbox').prop('checked', false).closest('.audio-item').removeClass('selected');
        updateBatchToolbar();
    });

    $('#delete-selected-btn').click(function() {
        var fs = [];
        $('#audio-container .item-checkbox:checked').each(function() { fs.push($(this).closest('.audio-item').data('filename')); });
        if (!fs.length) { layer.msg('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹'); return; }
        layer.confirm('ç¡®å®šåˆ é™¤ ' + fs.length + ' ä¸ªéŸ³é¢‘?', {title:false, btn:['æ˜¯','å¦']}, function() {
            $.ajax({
                url: '/delete_wavs_batch',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({filenames: fs}),
                success: function(res) {
                    if (res.code === 0) {
                        fs.forEach(function(f) { $('#audio-container .audio-item[data-filename="'+f+'"]').remove(); });
                        // æ¸…é™¤ç©ºæ‰¹æ¬¡
                        $('#audio-container .audio-batch').each(function() { if (!$(this).find('.audio-item').length) $(this).remove(); });
                        updateBatchToolbar();
                        layer.msg('å·²åˆ é™¤ ' + fs.length + ' é¡¹');
                    }
                }
            });
        });
    });

    $('#download-selected-btn').click(function() {
        var fs = [];
        $('#audio-container .item-checkbox:checked').each(function() { fs.push($(this).closest('.audio-item').data('filename')); });
        if (!fs.length) { layer.msg('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹'); return; }
        var $form = $('<form method="POST" action="/download_wavs_batch"></form>');
        // ä½¿ç”¨æ¢è¡Œä½œä¸ºåˆ†éš”ç¬¦ï¼Œé¿å…ä¸æ–‡ä»¶åä¸­çš„é€—å·å†²çª
        var $input = $('<input type="hidden" name="filenames">').val(fs.join('\n'));
        $form.append($input);
        $('body').append($form);
        $form.submit();
        $form.remove();
    });

    // === Submit ===
    $('#submit-btn').click(function() {
        var text = $textarea.val().trim();
        if (!text) { layer.msg('è¯·å…ˆè¾“å…¥æ–‡æœ¬'); return; }
        var idx = layer.load(1);
        var data = {
            text: text, prompt: $('#prompt').val(), voice: $('#voice').val(),
            speed: parseInt($('#speed').val()), temperature: parseFloat($('#temperature').val()),
            top_p: parseFloat($('#top_p').val()), top_k: parseInt($('#top_k').val()),
            refine_max_new_token: parseInt($('#refine_max_new_token').val()),
            infer_max_new_token: parseInt($('#infer_max_new_token').val()),
            text_seed: parseInt($('#text_seed').val()),
            skip_refine: $('#skip_refine').prop('checked') ? 1 : 0,
            is_stream: 0, custom_voice: $('#custom_voice').val() ? parseInt($('#custom_voice').val()) : 0,
            segment_len: parseInt($('#segment_len').val() || 0),
            segment_seconds: parseFloat($('#segment_seconds').val() || 0), split: 1
        };
        $.ajax({ url: '/tts', type: 'POST', data: data,
            success: function(res) {
                layer.close(idx);
                if (res.code === 0 && res.audio_files) appendAudioBatch(res.audio_files, data);
                else layer.alert(res.msg || 'ç”Ÿæˆå¤±è´¥', {title:false});
            },
            error: function() { layer.close(idx); layer.alert('è¯·æ±‚é”™è¯¯', {title:false}); }
        });
    });

    // === Event Handlers ===
    $(document).on('click', '.show-curl-btn', function() {
        var box = $(this).closest('.audio-item').find('.curl-container');
        box.toggleClass('d-none');
        if (!box.hasClass('d-none')) {
            var code = decodeURIComponent($(this).data('curl'));
            box.html('<pre style="margin:0; color:#a5f3fc; white-space:pre-wrap;">' + code + '</pre>');
        }
    });

    $(document).on('click', '.tts-token-btn', function() { insertToken($textarea, $(this).data('token')); });
    $(document).on('click', '.tone-preset-btn', function() { if ($(this).data('prompt')) $('#prompt').val($(this).data('prompt')); });

    $('#upload-btn').click(function() { $('#file-input').click(); });
    $('#file-input').change(function(e) {
        var f = e.target.files[0];
        if (f) { var r = new FileReader(); r.onload = function(e) { $textarea.val(e.target.result); updateLineNumbers(); }; r.readAsText(f, 'UTF-8'); }
    });

    $(document).on('click', '.delete-batch-btn', function() {
        var $b = $(this).closest('.audio-batch'), fs = [];
        $b.find('.audio-item').each(function() { fs.push($(this).data('filename')); });
        if (!fs.length) { $b.remove(); return; }
        layer.confirm('åˆ é™¤æœ¬æ‰¹æ¬¡?', {title:false}, function() {
            $.ajax({
                url: '/delete_wavs_batch',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({filenames: fs}),
                success: function(res) {
                    if (res.code === 0) { $b.remove(); updateBatchToolbar(); layer.msg('å·²åˆ é™¤'); }
                }
            });
        });
    });

    window.deleteWavItem = function(btn) {
        var $i = $(btn).closest('.audio-item'), f = $i.data('filename');
        if (!f) return;
        $.ajax({ url: '/delete_wav', type: 'POST', data: {filename: f}, success: function(res) {
            if (res.code === 0) { $i.remove(); updateBatchToolbar(); }
        }});
    };

    // Initialize tooltips
    $('[title]').each(function() { $(this).attr('data-bs-toggle', 'tooltip').attr('data-bs-placement', 'top'); });
    var ttList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    ttList.map(function(el) { return new bootstrap.Tooltip(el); });
});
</script>
</body>
</html>
