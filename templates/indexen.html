<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatTTS WebUI & API - v{{version}}</title>
    <link href="/static/js/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --border-color: #000;
            --border-width: 3px;
            --shadow-offset: 5px;
            --bg-color: #e0e7ff;
            --col-config: 260px;
            --col-result: 320px;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: #000;
            height: 100vh;
            overflow: hidden;
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .app-container {
            padding: 15px 25px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header-bar {
            flex: 0 0 auto;
            margin-bottom: 15px;
            background: #fff;
            border: var(--border-width) solid #000;
            box-shadow: 4px 4px 0 #000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-grid {
            flex: 1;
            display: flex;
            gap: 0;
            min-height: 0;
        }

        .panel-column {
            background: #fff;
            border: var(--border-width) solid #000;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 #000;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-width: 200px;
        }
        .config-col { width: var(--col-config); flex-shrink: 0; }
        .main-col { flex: 1; min-width: 300px; }
        .result-col { width: var(--col-result); flex-shrink: 0; }

        .splitter {
            width: 8px;
            background: linear-gradient(90deg, #ccc 1px, transparent 1px, transparent 3px, #ccc 3px);
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .splitter:hover, .splitter.dragging { background: #ff90e8; }

        @media (max-width: 1000px) {
            body { overflow: auto; height: auto; }
            .app-container { height: auto; display: block; padding: 10px; }
            .main-grid { display: flex; flex-direction: column; gap: 20px; height: auto; }
            .config-col, .main-col, .result-col { width: 100% !important; height: auto !important; }
            .splitter { display: none; }
            .panel-column { height: auto !important; max-height: none !important; overflow: visible !important; }
            #text-input { min-height: 250px; }
        }

        .panel-header {
            padding: 10px 15px;
            border-bottom: var(--border-width) solid #000;
            font-weight: 900;
            font-size: 1rem;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .panel-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        .header-config { background-color: #a5f3fc; }
        .header-main   { background-color: #ff90e8; }
        .header-result { background-color: #fde047; }

        .section-label {
            font-size: 0.75rem;
            font-weight: 800;
            color: #444;
            text-transform: uppercase;
            margin: 15px 0 8px 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 4px;
        }
        .section-label:first-child { margin-top: 0; }

        .form-control, .form-select {
            border: 2px solid #000 !important;
            border-radius: 0 !important;
            font-weight: 600;
            padding: 8px;
            font-size: 0.9rem;
        }
        .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.8);
            background: #fff;
            border-color: #000;
        }

        .editor-wrap {
            display: flex;
            flex: 1;
            border: 2px solid #000;
            background: #fff;
            min-height: 150px;
        }
        .line-numbers {
            background: #f5f5f5;
            border-right: 2px solid #000;
            padding: 10px 8px;
            text-align: right;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #888;
            user-select: none;
            overflow: hidden;
        }
        .editor-wrap textarea {
            flex: 1;
            border: none !important;
            resize: none;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 10px;
            outline: none;
            font-family: inherit;
        }

        .btn {
            border: 2px solid #000;
            border-radius: 0;
            font-weight: 800;
            text-transform: uppercase;
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        .btn:hover { filter: brightness(1.05); }
        .btn:active { filter: brightness(0.95); }

        .btn-main {
            background: #000;
            color: #fff;
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            letter-spacing: 1px;
            box-shadow: 4px 4px 0 #555;
        }
        .btn-main:hover { color: #fde047; background: #222; }

        .btn-tag {
            background: #fff;
            font-size: 0.8rem;
            padding: 4px 8px;
            margin: 0 4px 4px 0;
            box-shadow: 2px 2px 0 #ddd;
        }
        .btn-tag:hover { background: #fde047; box-shadow: 2px 2px 0 #000; }

        input[type=range] {
            width: 100%;
            height: 20px;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            margin: 5px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 4px;
            background: #000;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 16px;
            width: 16px;
            background: #ff90e8;
            border: 2px solid #000;
            -webkit-appearance: none;
            margin-top: -6px;
        }

        .audio-item {
            border: 2px solid #000;
            background: #fff;
            margin-bottom: 10px;
            padding: 10px;
            box-shadow: 3px 3px 0 #ddd;
            font-size: 0.85rem;
        }
        .audio-item:hover { box-shadow: 4px 4px 0 #000; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f5f5f5; }
        ::-webkit-scrollbar-thumb { background: #000; }

        .tip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #000;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            vertical-align: middle;
        }

        .input-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #555;
            margin-bottom: 2px;
            display: block;
        }

        #upload-btn { position: relative; overflow: hidden; }
        #file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:10; }

        .github-links a {
            margin-left: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            color: #000;
            text-decoration: none;
            padding: 6px 10px;
            border: 2px solid #000;
            background: #fff;
        }
        .github-links a:hover { background: #fde047; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header-bar">
        <div class="d-flex align-items-center gap-2">
            <h1 class="m-0" style="font-weight:900; font-size:1.5rem;">CHAT_TTS <span style="color:#ff90e8">UI</span></h1>
            <span class="badge bg-warning text-dark border border-dark rounded-0 p-1" style="font-size:0.7rem;">v{{version}}</span>
        </div>
        <div class="github-links">
            <a href="https://github.com/jianchang512/chatTTS-ui" target="_blank">ChatTTS-UI</a>
            <a href="https://github.com/2noise/ChatTTS" target="_blank">ChatTTS</a>
        </div>
    </div>

    <div class="main-grid">
        <!-- Config Column -->
        <div class="panel-column config-col" id="config-col">
            <div class="panel-header header-config"><span>Config</span><span>‚öôÔ∏è</span></div>
            <div class="panel-body">
                <div class="section-label">Voice Settings</div>
                <select id="voice" class="form-select mb-2">
                    {% for speaker in speakers %}
                    <option value="{{speaker}}">{{speaker}}</option>
                    {% endfor %}
                </select>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="input-label">Custom Voice ID <span class="tip-icon" title="If set, overrides voice selection. Use values like 2000, 8000, etc.">?</span></label>
                        <input id="custom_voice" type="number" class="form-control" placeholder="e.g. 3000">
                    </div>
                    <div class="col-6">
                        <label class="input-label">Text Seed <span class="tip-icon" title="Random seed for text generation, affects output variability">?</span></label>
                        <input id="text_seed" type="number" class="form-control" value="42">
                    </div>
                </div>

                <div class="section-label">Model Parameters</div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="input-label mb-0">Speed <span class="tip-icon" title="Speech speed: 1=slowest, 9=fastest, default 5">?</span></span>
                        <span class="badge bg-dark rounded-0" id="val-speed">5</span>
                    </div>
                    <input type="range" id="speed" min="1" max="9" value="5" oninput="document.getElementById('val-speed').innerText=this.value">
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="input-label mb-0">Temp <span class="tip-icon" title="Sampling temperature: higher=more random, lower=more stable">?</span></span>
                        <span class="badge bg-dark rounded-0" id="val-temp">0.1</span>
                    </div>
                    <input type="range" id="temperature" min="0.00001" max="1.0" step="0.05" value="0.1" oninput="document.getElementById('val-temp').innerText=parseFloat(this.value).toFixed(2)">
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="input-label mb-0">Top P <span class="tip-icon" title="Nucleus sampling parameter, controls diversity">?</span></span>
                            <span class="small" id="val-topp">0.7</span>
                        </div>
                        <input type="range" id="top_p" min="0.1" max="0.9" step="0.05" value="0.7" oninput="document.getElementById('val-topp').innerText=parseFloat(this.value).toFixed(2)">
                    </div>
                    <div class="col-6">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="input-label mb-0">Top K <span class="tip-icon" title="Top-K sampling, limits candidate tokens per step">?</span></span>
                            <span class="small" id="val-topk">20</span>
                        </div>
                        <input type="range" id="top_k" min="1" max="20" value="20" oninput="document.getElementById('val-topk').innerText=this.value">
                    </div>
                </div>

                <div class="section-label">Prompt & Advanced</div>
                <label class="input-label">Refine Prompt <span class="tip-icon" title="Tone control prompt, e.g. [oral_2][laugh_0][break_6]. oral=casualness(0-9), laugh=laughter(0-2), break=pause(0-7)">?</span></label>
                <textarea id="prompt" class="form-control mb-2" rows="2" style="font-size:0.85rem;">[oral_2][laugh_0][break_6]</textarea>
                
                <button class="btn w-100 border-dark bg-light text-start py-2" type="button" data-bs-toggle="collapse" data-bs-target="#advConfig">
                    ‚ñº Advanced Options
                </button>
                <div class="collapse" id="advConfig">
                    <div class="card card-body border-dark rounded-0 p-2 bg-light mt-2">
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="input-label">Seg Length <span class="tip-icon" title="Max characters per segment, 0=auto">?</span></label>
                                <input id="segment_len" type="number" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="input-label">Seg Duration(s) <span class="tip-icon" title="Target duration per segment in seconds, >0 takes priority">?</span></label>
                                <input id="segment_seconds" type="number" class="form-control" value="0">
                            </div>
                            <div class="col-6">
                                <label class="input-label">Infer Token <span class="tip-icon" title="Max inference tokens, default 2048">?</span></label>
                                <input id="infer_max_new_token" type="number" class="form-control" value="2048">
                            </div>
                            <div class="col-6">
                                <label class="input-label">Refine Token <span class="tip-icon" title="Max refine text tokens, default 384">?</span></label>
                                <input id="refine_max_new_token" type="number" class="form-control" value="384">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input border-dark" id="skip_refine" checked>
                            <label class="form-check-label small fw-bold" for="skip_refine">Skip Refine Text <span class="tip-icon" title="Enable if text has control tokens or quality is poor">?</span></label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="splitter" id="splitter1"></div>

        <!-- Main Column -->
        <div class="panel-column main-col" id="main-col">
            <div class="panel-header header-main"><span>Workspace</span><span>üìù</span></div>
            <div class="panel-body d-flex flex-column">
                <div class="editor-wrap mb-3">
                    <div class="line-numbers" id="line-numbers">1</div>
                    <textarea id="text-input" placeholder="Enter text to convert...&#10;One sentence per line recommended..."></textarea>
                </div>

                <div class="section-label mt-0">Quick Tokens <span class="tip-icon" title="Click to insert at cursor. [laugh]=laughter [uv_break]=pause [oral_N]=casualness [break_N]=pause strength">?</span></div>
                <div class="d-flex flex-wrap mb-3">
                    <button class="btn btn-tag tts-token-btn" data-token="[laugh]">[laugh]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[uv_break]">[uv_break]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[oral_2]">[oral_2]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[laugh_0]">[laugh_0]</button>
                    <button class="btn btn-tag tts-token-btn" data-token="[break_6]">[break_6]</button>
                </div>

                <div class="section-label">Tone Presets</div>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_2][laugh_0][break_6]">üòä Chat</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_0][break_4]">üéôÔ∏è Broadcast</button>
                    <button class="btn btn-light flex-fill border-dark tone-preset-btn py-2" data-prompt="[oral_3][laugh_1][break_3]">üé≠ Dramatic</button>
                </div>

                <button id="submit-btn" class="btn btn-main mb-2">‚ö° Generate</button>
                
                <div class="d-flex gap-2">
                    <button id="upload-btn" class="btn btn-light flex-fill border-dark py-2">
                        üìÇ Import TXT
                        <input type="file" id="file-input" accept=".txt">
                    </button>
                    <button id="clear-btn" class="btn flex-fill border-dark py-2" style="background:#ff4d4d; color:white;">üóëÔ∏è Clear</button>
                </div>
            </div>
        </div>

        <div class="splitter" id="splitter2"></div>

        <!-- Result Column -->
        <div class="panel-column result-col" id="result-col">
            <div class="panel-header header-result"><span>Results</span><span>üéµ</span></div>
            <div class="panel-body" id="audio-container">
                <div class="text-center text-muted mt-4" id="empty-state">
                    <div style="font-size:3rem; opacity:0.15;">‚àÖ</div>
                    <div class="small">No audio generated</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    // === Line Numbers ===
    var $textarea = $('#text-input');
    var $lineNums = $('#line-numbers');
    
    function updateLineNumbers() {
        var lines = $textarea.val().split('\n').length;
        var nums = [];
        for (var i = 1; i <= Math.max(lines, 1); i++) nums.push(i);
        $lineNums.html(nums.join('<br>'));
    }
    
    $textarea.on('input scroll', function() {
        updateLineNumbers();
        $lineNums.scrollTop($textarea.scrollTop());
    });
    updateLineNumbers();

    // === Splitter Resize ===
    function initSplitter(splitterId, leftColId, rightColId, minLeft, minRight) {
        var $splitter = $('#' + splitterId);
        var $left = $('#' + leftColId);
        var $right = $('#' + rightColId);
        var dragging = false;
        
        $splitter.on('mousedown', function(e) {
            e.preventDefault();
            dragging = true;
            $splitter.addClass('dragging');
            $(document).on('mousemove.splitter', function(e) {
                if (!dragging) return;
                var containerLeft = $('.main-grid').offset().left;
                var containerWidth = $('.main-grid').width();
                
                if (splitterId === 'splitter1') {
                    var newWidth = e.pageX - containerLeft;
                    newWidth = Math.max(minLeft, Math.min(newWidth, containerWidth - minRight - 350));
                    $left.css('width', newWidth + 'px');
                } else {
                    var rightEdge = containerLeft + containerWidth;
                    var newWidth = rightEdge - e.pageX;
                    newWidth = Math.max(minRight, Math.min(newWidth, containerWidth - minLeft - 350));
                    $right.css('width', newWidth + 'px');
                }
            });
            $(document).on('mouseup.splitter', function() {
                dragging = false;
                $splitter.removeClass('dragging');
                $(document).off('.splitter');
            });
        });
    }
    
    initSplitter('splitter1', 'config-col', 'main-col', 200, 250);
    initSplitter('splitter2', 'main-col', 'result-col', 250, 200);

    // === Smart Token Insert ===
    function insertToken($textarea, token) {
        var el = $textarea.get(0);
        if (!el) return;
        var start = el.selectionStart || 0;
        var value = el.value;
        
        var charBefore = start > 0 ? value.charAt(start - 1) : '';
        var insertText = token;
        
        if (start > 0 && charBefore !== ' ' && charBefore !== '\n' && charBefore !== '[' && charBefore !== ']') {
            insertText = ' ' + token;
        }
        
        el.value = value.substring(0, start) + insertText + value.substring(start);
        el.focus();
        var newPos = start + insertText.length;
        el.selectionStart = el.selectionEnd = newPos;
        updateLineNumbers();
    }

    // === Audio Item ===
    function appendAudioItem(audio, autoPlay, curlCode, $container) {
        $('#empty-state').remove();
        var pos = audio.filename.lastIndexOf('/') + 1;
        var filename = audio.filename.substr(pos);
        var count = $('#audio-container').find('.audio-item').length + 1;
        var badge = '';
        if (audio.is_merged === 1) badge = '<span class="badge bg-success text-dark rounded-0 ms-1">Merged</span>';
        else if (audio.part_index) badge = '<span class="badge bg-secondary rounded-0 ms-1">P' + audio.part_index + '</span>';
        
        var durationText = (audio.audio_duration && audio.audio_duration > 0) ? ' | ' + audio.audio_duration + 's' : '';
        var autoplayAttr = autoPlay ? ' autoplay' : '';
        curlCode = curlCode || '';
        $container = $container || $('#audio-container');

        var html = `
        <div class="audio-item" data-filename="${filename}">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="fw-bold text-truncate" style="max-width:80%; font-size:0.8rem;">#${count} ${filename}${badge}</div>
                <button onclick="deleteWavItem(this)" class="btn btn-link text-danger p-0" style="font-size:1.2rem; line-height:1;">&times;</button>
            </div>
            <audio controls${autoplayAttr} src="${audio.url}" style="width:100%; height:28px;"></audio>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="text-muted" style="font-size:0.75rem;">${audio.inference_time || 0}s${durationText}</div>
                <div class="d-flex gap-1">
                    <button class="btn btn-info btn-sm py-0 px-1 rounded-0 border-dark text-white show-curl-btn" style="font-size:0.7rem;" data-curl="${encodeURIComponent(curlCode)}">API</button>
                    <a href="${audio.url}" download="${filename}" class="btn btn-success btn-sm py-0 px-1 rounded-0 border-dark" style="font-size:0.7rem;">DL</a>
                </div>
            </div>
            <div class="mt-2 bg-dark text-light d-none curl-container p-2" style="font-size:0.7rem; word-break:break-all;"></div>
        </div>`;
        $container.prepend(html);
    }

    function appendAudioBatch(audioList, data) {
        if (!audioList || audioList.length === 0) return;
        var batchIndex = $('#audio-container').find('.audio-batch').length + 1;
        var batchId = 'batch-' + Date.now();
        var html = `
        <div class="audio-batch mb-3" data-batch-id="${batchId}">
            <div class="bg-warning border border-dark p-1 px-2 d-flex justify-content-between align-items-center" style="font-size:0.85rem;">
                <span class="fw-bold">BATCH #${batchIndex} [${audioList.length}]</span>
                <button class="btn btn-dark btn-sm py-0 px-1 rounded-0 delete-batch-btn" style="font-size:0.7rem;">DEL ALL</button>
            </div>
            <div class="batch-body p-1 border border-dark border-top-0 bg-white"></div>
        </div>`;
        $('#audio-container').prepend(html);
        var $body = $('#audio-container').find('.audio-batch').first().find('.batch-body');
        
        var curlParts = [];
        for (var key in data) {
            if (data.hasOwnProperty(key)) {
                curlParts.push('-d "' + key + '=' + encodeURIComponent(data[key]) + '"');
            }
        }
        var curlCode = 'curl -X POST "http://' + location.host + '/tts" \\\n  ' + curlParts.join(' \\\n  ');
        
        audioList.forEach(function(audio) {
            appendAudioItem(audio, true, curlCode, $body);
        });
    }

    function loadAudioList() {
        $.ajax({
            url: '/list_wavs',
            type: 'GET',
            success: function(response) {
                if (response.code === 0 && response.audio_files && response.audio_files.length > 0) {
                    $('#audio-container').empty();
                    response.audio_files.forEach(function(audio) { appendAudioItem(audio, false, ''); });
                }
            }
        });
    }
    loadAudioList();

    // === Submit ===
    $('#submit-btn').click(function() {
        var text = $textarea.val().trim();
        if (!text) { layer.msg('Enter text first'); return; }
        var index = layer.load(1);
        
        var data = {
            text: text,
            prompt: $('#prompt').val(),
            voice: $('#voice').val(),
            speed: parseInt($('#speed').val()),
            temperature: parseFloat($('#temperature').val()),
            top_p: parseFloat($('#top_p').val()),
            top_k: parseInt($('#top_k').val()),
            refine_max_new_token: parseInt($('#refine_max_new_token').val()),
            infer_max_new_token: parseInt($('#infer_max_new_token').val()),
            text_seed: parseInt($('#text_seed').val()),
            skip_refine: $('#skip_refine').prop('checked') ? 1 : 0,
            is_stream: 0,
            custom_voice: $('#custom_voice').val() ? parseInt($('#custom_voice').val()) : 0,
            segment_len: parseInt($('#segment_len').val() || 0),
            segment_seconds: parseFloat($('#segment_seconds').val() || 0),
            split: 1
        };

        $.ajax({
            url: '/tts',
            type: 'POST',
            data: data,
            success: function(res) {
                layer.close(index);
                if (res.code === 0 && res.audio_files) { appendAudioBatch(res.audio_files, data); }
                else { layer.alert(res.msg || 'Generation failed', {title:false}); }
            },
            error: function() { layer.close(index); layer.alert('Request error', {title:false}); }
        });
    });

    // === Event Handlers ===
    $(document).on('click', '.show-curl-btn', function() {
        var box = $(this).closest('.audio-item').find('.curl-container');
        box.toggleClass('d-none');
        if (!box.hasClass('d-none')) {
            box.html('<pre style="margin:0; color:#a5f3fc; white-space:pre-wrap;">' + decodeURIComponent($(this).data('curl')) + '</pre>');
        }
    });

    $(document).on('click', '.tts-token-btn', function() { insertToken($textarea, $(this).data('token')); });
    $(document).on('click', '.tone-preset-btn', function() { 
        if ($(this).data('prompt')) $('#prompt').val($(this).data('prompt')); 
    });

    $('#upload-btn').click(function() { $('#file-input').click(); });
    $('#file-input').change(function(e) {
        var f = e.target.files[0];
        if (f) {
            var r = new FileReader();
            r.onload = function(e) { $textarea.val(e.target.result); updateLineNumbers(); };
            r.readAsText(f, 'UTF-8');
        }
    });

    $('#clear-btn').click(function() {
        layer.confirm('Clear all audio?', {title:false, btn:['Yes','No']}, function() {
            $.ajax({url:'/clear_wavs', type:'POST', success:function(res) {
                if (res.code === 0) { 
                    $('#audio-container').html('<div class="text-center text-muted mt-4" id="empty-state"><div style="font-size:3rem;opacity:0.15;">‚àÖ</div><div class="small">No audio generated</div></div>'); 
                    layer.msg('Cleared'); 
                }
            }});
        });
    });

    $(document).on('click', '.delete-batch-btn', function() {
        var $b = $(this).closest('.audio-batch');
        var fs = [];
        $b.find('.audio-item').each(function() { fs.push($(this).data('filename')); });
        if (!fs.length) { $b.remove(); return; }
        layer.confirm('Delete batch?', {title:false}, function() {
            $.ajax({url:'/delete_wavs_batch', type:'POST', data:{filenames:fs.join(',')}, success:function(res) {
                if (res.code === 0) { $b.remove(); layer.msg('Deleted'); }
            }});
        });
    });

    window.deleteWavItem = function(btn) {
        var $i = $(btn).closest('.audio-item');
        var f = $i.data('filename');
        if (!f) return;
        $.ajax({url:'/delete_wav', type:'POST', data:{filename:f}, success:function(res) {
            if (res.code === 0) $i.remove();
        }});
    };

    // Initialize Bootstrap tooltips
    $('[title]').each(function() {
        $(this).attr('data-bs-toggle', 'tooltip').attr('data-bs-placement', 'top');
    });
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(el) { return new bootstrap.Tooltip(el); });
});
</script>
</body>
</html>
