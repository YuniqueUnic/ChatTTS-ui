<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ChatTTS WebUI & API - v{{version}}</title>
    <link href="/static/js/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --surface-color: #ffffff;
            --border-color: #000000;
            --shadow-color: #000000;
            --primary-color: #a8dadc;
            --accent-color: #ff6b6b;
            --text-color: #000000;
            --border-width: 3px;
            --shadow-offset: 5px;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace; /* Brutalist style font */
            color: var(--text-color);
            padding-bottom: 50px;
        }

        /* Brutalist Components */
        .brutal-box {
            background-color: var(--surface-color);
            border: var(--border-width) solid var(--border-color);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px var(--shadow-color);
            padding: 20px;
            margin-bottom: 25px;
            transition: transform 0.2s;
        }
        
        .brutal-box:hover {
            transform: translate(-1px, -1px);
        }

        .brutal-header {
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: var(--border-width) solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            letter-spacing: -1px;
        }

        /* Form Controls */
        .form-control, .form-select, .input-group-text {
            border: 2px solid var(--border-color) !important;
            border-radius: 0 !important;
            color: var(--text-color) !important;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            font-weight: 600;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 4px 4px 0px var(--border-color);
            background-color: #fffae6;
            transform: translate(-2px, -2px);
            outline: none;
        }

        .input-group-text {
            background-color: var(--border-color) !important;
            color: var(--surface-color) !important;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            border: 2px solid var(--border-color);
            border-radius: 0;
            box-shadow: 4px 4px 0px var(--shadow-color);
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.15s;
            margin: 5px;
            position: relative;
            top: 0;
            left: 0;
        }

        .btn:hover {
            box-shadow: 6px 6px 0px var(--shadow-color);
            transform: translate(-2px, -2px);
        }

        .btn:active {
            box-shadow: 2px 2px 0px var(--shadow-color);
            transform: translate(2px, 2px);
        }

        .btn-primary { background-color: #4cc9f0 !important; color: black !important; }
        .btn-secondary { background-color: #e0e0e0 !important; color: black !important; }
        .btn-warning { background-color: #ffd166 !important; color: black !important; }
        .btn-danger { background-color: #ef476f !important; color: black !important; }
        .btn-outline-secondary { color: black !important; border-color: black !important; }
        .btn-outline-secondary:hover { background-color: black !important; color: white !important; }
        .btn-info { background-color: #118ab2 !important; color: white !important; }
        .btn-success { background-color: #06d6a0 !important; color: black !important; }

        /* Sliders */
        input[type=range] {
            accent-color: var(--border-color);
            height: 20px;
        }

        /* Custom UI tweaks */
        #text-input {
            min-height: 250px;
            font-size: 1.1rem;
            resize: vertical;
        }

        .audio-item {
            border: 2px solid var(--border-color);
            background: #fff;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 4px 4px 0 #ddd;
        }
        
        .badge {
            border: 1px solid black;
            border-radius: 0;
            color: black !important;
        }
        .badge.bg-success { background-color: #06d6a0 !important; }
        .badge.bg-secondary { background-color: #ddd !important; }

        /* Helper Classes */
        .font12 { font-size: 12px; font-weight: bold; }
        .param-label { font-size: 0.85rem; font-weight: bold; display: block; margin-bottom: 5px; }
        
        #upload-btn { position: relative; overflow: hidden; }
        #file-input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        .section-label {
            background: black;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: inline-block;
        }
    </style>
</head>
<body>

<div class="container my-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-4" style="font-weight: 900; text-shadow: 3px 3px 0px #ddd;">CHAT_TTS <span style="font-size: 0.5em; background: black; color: white; padding: 0 10px;">WebUI</span></h1>
        </div>
        <div class="col-md-4 text-end">
            <span class="badge bg-light text-dark border border-dark">v{{version}}</span>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Input -->
        <div class="col-lg-7">
            <div class="brutal-box">
                <div class="brutal-header">1. TEXT INPUT</div>
                <textarea id="text-input" class="form-control mb-3" placeholder="Enter the text to be converted here, synthesize by line..."></textarea>
                
                <div class="mb-3">
                    <span class="section-label">QUICK TOKENS</span>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary tts-token-btn" data-token="[laugh]">[laugh]</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tts-token-btn" data-token="[uv_break]">[uv_break]</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tts-token-btn" data-token="[oral_2]">[oral_2]</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tts-token-btn" data-token="[laugh_0]">[laugh_0]</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tts-token-btn" data-token="[break_6]">[break_6]</button>
                    </div>
                </div>

                <div>
                    <span class="section-label">TONE PRESETS</span>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary tone-preset-btn" data-prompt="[oral_2][laugh_0][break_6]" title="Casual chatting tone">Chat</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tone-preset-btn" data-prompt="[oral_0][break_4]" title="Formal broadcast tone">Broadcast</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary tone-preset-btn" data-prompt="[oral_3][laugh_1][break_3]" title="Exaggerated, emotional tone">Exaggerated</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Parameters -->
        <div class="col-lg-5">
            <div class="brutal-box">
                <div class="brutal-header">2. PARAMETERS</div>
                
                <!-- Voice Settings -->
                <div class="mb-4 border-bottom border-dark pb-3">
                    <span class="section-label">VOICE SETTINGS</span>
                    <div class="row g-2 align-items-center mb-2">
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">Select Voice</span>
                                <select id="voice" class="form-select">
                                    {% for speaker in speakers %}
                                        <option value="{{speaker}}">{{speaker}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">Custom Voice</span>
                                <input id="custom_voice" class="form-control" type="number" min="0" placeholder="e.g. 2000 (overrides selection)">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="input-group">
                                <span class="input-group-text">Text Seed</span>
                                <input id="text_seed" class="form-control" value="42" type="number" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prompt & Segmentation -->
                <div class="mb-4 border-bottom border-dark pb-3">
                    <span class="section-label">ADVANCED CONTROL</span>
                    <div class="input-group mb-2">
                        <span class="input-group-text">Prompt</span>
                        <input id="prompt" value="[break_6]" class="form-control" placeholder="e.g. [oral_2][break_6]">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="font12">Segment Len</label>
                            <input id="segment_len" class="form-control form-control-sm" value="0" type="number" min="0" title="0=auto">
                        </div>
                        <div class="col-6">
                            <label class="font12">Segment Secs</label>
                            <input id="segment_seconds" class="form-control form-control-sm" value="0" type="number" min="0" step="1">
                        </div>
                    </div>
                    <div class="form-check mt-2">
                        <input type="checkbox" checked class="form-check-input" id="skip_refine" style="border: 2px solid black;">
                        <label class="form-check-label fw-bold" for="skip_refine">Skip Refine Text (Recommended)</label>
                    </div>
                </div>

                <!-- Sliders -->
                <div id="temper_wrap">
                    <span class="section-label">INFERENCE PARAMS</span>
                    
                    <div class="row g-2 mb-2">
                         <div class="col-6">
                            <label class="font12">Speed: <span id="val-speed">5</span></label>
                            <input type="range" class="form-range" id="speed" min="1" max="9" step="1" value="5" oninput="document.getElementById('val-speed').innerText=this.value">
                        </div>
                        <div class="col-6">
                            <label class="font12">Temp: <span id="val-temp">0.1</span></label>
                            <input type="range" class="form-range" id="temperature" min="0.00001" max="1.0" step="0.00001" value="0.1" oninput="document.getElementById('val-temp').innerText=this.value">
                        </div>
                        <div class="col-6">
                            <label class="font12">Top_P: <span id="val-topp">0.7</span></label>
                            <input type="range" class="form-range" id="top_p" min="0.001" max="0.9" step="0.05" value="0.7" oninput="document.getElementById('val-topp').innerText=this.value">
                        </div>
                        <div class="col-6">
                            <label class="font12">Top_K: <span id="val-topk">20</span></label>
                            <input type="range" class="form-range" id="top_k" min="1" max="20" step="1" value="20" oninput="document.getElementById('val-topk').innerText=this.value">
                        </div>
                    </div>

                    <div class="row g-2 mt-2 d-none">
                        <!-- Hidden or less used tokens params can stay here or be collapsed -->
                         <div class="col-6">
                            <label class="font12">Infer Token</label>
                            <input id="infer_max_new_token" class="form-control form-control-sm" value="2048" type="number">
                        </div>
                        <div class="col-6">
                             <label class="font12">Refine Token</label>
                             <input id="refine_max_new_token" class="form-control form-control-sm" value="384" type="number">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="brutal-box text-center" style="background: #000; color: white;">
                <button id="submit-btn" class="btn btn-primary btn-lg w-50 py-3 fs-4">‚ö° SYNTHESIZE VOICE NOW</button>
                <div class="mt-3 d-flex justify-content-center gap-3">
                    <button id="upload-btn" class="btn btn-secondary btn-sm">
                        üìÇ IMPORT TXT
                        <input type="file" id="file-input" accept=".txt">
                    </button>
                    <button id="clear-btn" class="btn btn-danger btn-sm">üóëÔ∏è CLEAR ALL WAVs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Section -->
    <div class="row">
        <div class="col-12">
            <div id="audio-container"></div>
            <div class="m-2 bg-black text-white d-none p-3 border border-white" id="code" style="font-family: monospace;"></div>
        </div>
    </div>
    
    <!-- Footer -->
    <div class="text-center my-5 py-4 border-top border-dark border-3">
        <a class="btn btn-link text-dark fw-bold text-decoration-none" href="https://github.com/jianchang512/chatTTS-ui" target="_blank">[GITHUB: UI]</a>
        <a class="btn btn-link text-dark fw-bold text-decoration-none" href="https://github.com/2noise/ChatTTS" target="_blank">[GITHUB: CORE]</a>
    </div>
</div>

<!-- Hidden Inputs for JS compatibility if I missed any direct IDs in layout -->
<div class="d-none">
    <!-- Refine token hidden input if not displayed above -->
    <input id="infer_max_new_token" value="2048">
    <input id="refine_max_new_token" value="384">
</div>

<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
  // Initialize Tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });

    let audioGenerated = false;

	function insertToken($textarea, token) {
		var el = $textarea.get(0);
		if (!el) { return; }
		var start = el.selectionStart || 0;
		var end = el.selectionEnd || 0;
		var value = el.value;
		el.value = value.substring(0, start) + token + value.substring(end);
		el.focus();
		var newPos = start + token.length;
		el.selectionStart = el.selectionEnd = newPos;
	}

	function appendAudioItem(audio, autoPlay, jsCode, $container) {
		let pos = audio.filename.lastIndexOf('/') + 1;
		let filename = audio.filename.substr(pos);
		let count = $('#audio-container').find('div.audio-item').length + 1;
		let badge = '';
		if (audio.is_merged === 1) {
			badge = '<span class="badge bg-success ms-2">Merged</span>';
		} else if (audio.part_index) {
			badge = '<span class="badge bg-secondary ms-2">Part ' + audio.part_index + '</span>';
		}
		let durationText = (audio.audio_duration && audio.audio_duration > 0) ? ' | Duration: ' + audio.audio_duration + ' s' : '';
		let autoplayAttr = autoPlay ? ' autoplay' : '';
		jsCode = jsCode || '';
		$container = $container || $('#audio-container');
		$container.prepend(
			`
			  <div class="col-12 audio-item brutal-box p-3" data-filename="${filename}">
				<div class="d-flex justify-content-between align-items-center border-bottom border-dark pb-2 mb-2">					
					<span class="fw-bold">[${count}] ${filename} ${badge}</span>
                    <button onclick="$(this).closest('.audio-item').remove()" class="btn btn-sm btn-outline-dark py-0 px-2">X</button>
				</div>
				<div class="d-flex flex-wrap align-items-center my-2 gap-2">
					<audio controls${autoplayAttr} src="${audio.url}" class="me-2" style="height: 40px; border: 2px solid black; border-radius: 0;"></audio>
					<a href="${audio.url}" download="${filename}" class="btn btn-success btn-sm">‚¨á Download</a>
					<button type="button" class="btn btn-danger btn-sm delete-wav-btn">Delete</button>
                    <button class="btn btn-info btn-sm show-js-btn" data-js-code="${encodeURIComponent(jsCode)}">API</button>
				</div>
				<div class="text-secondary font12 mt-1">
					Inference Time: ${audio.inference_time}s${durationText}
				</div>
				<div class="mt-2 bg-black text-white d-none code-container p-2 font12"></div>
			  </div>
			`);
	}

	function appendAudioBatch(audioList, data) {
		if (!audioList || audioList.length === 0) {
			return;
		}
		let batchIndex = $('#audio-container').find('.audio-batch').length + 1;
		let batchId = 'batch-' + Date.now() + '-' + Math.random().toString().slice(2, 7);
		let headerText = `BATCH #${batchIndex} [FILES: ${audioList.length}]`;
		let batchHtml = `
			<div class="col-12 mb-4 audio-batch" data-batch-id="${batchId}">
			  <div class="d-flex justify-content-between align-items-center bg-black text-white px-3 py-2 border border-dark">
				<div class="fw-bold">${headerText}</div>
				<div>
				  <button type="button" class="btn btn-sm btn-danger border-white delete-batch-btn">DELETE BATCH</button>
				</div>
			  </div>
			  <div class="mt-2 batch-body"></div>
			</div>
		`;
		$('#audio-container').prepend(batchHtml);
		let $batch = $('#audio-container').find('.audio-batch').first();
		let $body = $batch.find('.batch-body');
		audioList.forEach(function(audio) {
			let jsCode = `# API Call Code\n\nimport requests\n\nres = requests.post('http://${location.host}/tts', data=${JSON.stringify(data, null, 2)})\nprint(res.json())\n\n#ok\n{code:0, msg:'ok', audio_files:[{filename: ${audio.filename}, url: ${audio.url}}]}\n\n#error\n{code:1, msg:"error"}\n`;
			appendAudioItem(audio, true, jsCode, $body);
		});
	}

	function loadAudioList() {
		$.ajax({
			url: '/list_wavs',
			type: 'GET',
			success: function(response) {
				if (response.code === 0 && response.audio_files) {
					$('#audio-container').empty();
					response.audio_files.forEach(function(audio) {
						appendAudioItem(audio, false, '');
					});
				}
			}
		});
	}

	loadAudioList();

    // Update slider values display
    // (Handled by inline oninput, but keeping compatibility if needed)
    $('#temper_wrap input[type="range"]').on('input',function(){
        // Logic moved to inline for cleaner brutality
    });

    $('#submit-btn').click(function() {
        var text = $('#text-input').val().trim();
        if (text === '') {
            layer.alert('Must enter text',{title:false, skin: 'layui-layer-molv'});
        } else {
			let index=layer.load(1, {shade: [0.5,'#fff']}); // Use cleaner loader
			let custom_voice=$('#custom_voice').val();
			
			let data={
				text: text,
				prompt:$('#prompt').val(),
				voice:$('#voice').val(),
				speed:parseInt($('#speed').val()),
				temperature:parseFloat($('#temperature').val()),
				top_p:parseFloat($('#top_p').val()),
				top_k:parseInt($('#top_k').val()),
				refine_max_new_token:parseInt($('#refine_max_new_token').val()),
				infer_max_new_token:parseInt($('#infer_max_new_token').val()),
				text_seed:parseInt($('#text_seed').val()),
				text_seed:parseInt($('#text_seed').val()),
				skip_refine:$('#skip_refine').prop('checked')?1:0,
				is_stream:0,
				custom_voice:custom_voice?parseInt(custom_voice):0,
				segment_len:parseInt($('#segment_len').val() || 0),
				segment_seconds:parseFloat($('#segment_seconds').val() || 0),
				split:1
			};

      $.ajax({
        url: '/tts',
        type: 'POST',
        data: data,
        timeout: 3600000,
        success: function(response) {
          if (response.code === 0) {
            console.log(response);
            if (response.audio_files) {
              appendAudioBatch(response.audio_files, data);
              audioGenerated = true;
            } else {
              layer.alert('Audio generation failed', {title: false});
            }
          } else {
            layer.alert(response.msg, {title: false});
          }
        },
        error: function(xhr, status, error) {
          layer.alert('Error: ' + error, {title: false});
        },
        complete: function() {
          layer.close(index);
        }
      });
    }
  });

  $(document).on('click', '.show-js-btn', function() {
    let codeContainer = $(this).parent().next('.code-container'); // Logic adjustment for new layout?
    // In new layout: .d-flex (btn parent) -> .font12 -> .code-container is sibling of .font12, not btn parent
    // The btn is in a div, the code container is at the end of .audio-item
    let item = $(this).closest('.audio-item');
    codeContainer = item.find('.code-container');
    
    codeContainer.toggleClass('d-none');
    if (!codeContainer.hasClass('d-none')) {
      codeContainer.html(`<pre style="margin:0; color:white;"><code>${decodeURIComponent($(this).data('js-code'))}</code></pre>`);
    }
  });

	$(document).on('click', '.tts-token-btn', function() {
		var token = $(this).data('token');
		insertToken($('#text-input'), token);
	});

	$(document).on('click', '.tone-preset-btn', function() {
		var preset = $(this).data('prompt');
		if (preset) {
			$('#prompt').val(preset);
		}
	});

	$('#upload-btn').click(function() {
        $('#file-input').click()
    });
    
    $('#file-input').change(function(e) {
        var file = e.target.files[0];
        if(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#text-input').val(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }
    });

    $('#clear-btn').click(function() {
    layer.confirm('Delete all wav files?', {
      btn: ['Yes', 'No'],
	  title:false
    }, function() {
	  layer.msg('Cleaning...')	 
      $.ajax({
        url: '/clear_wavs',
        type: 'POST',
        success: function(response) {
          if (response.code === 0) {
		    $('#audio-container').html('')
            layer.alert('Successfully cleaned', {title: false});
          } else {
            layer.alert('Cleaning failed: ' + response.msg, {title: false});
          }
        },
        error: function(xhr, status, error) {
          layer.alert('Error: ' + error, {title: false});
        }
      });
    });
  });

  $(document).on('click', '.delete-batch-btn', function() {
		var $batch = $(this).closest('.audio-batch');
		var filenames = [];
		$batch.find('.audio-item').each(function() {
			var name = $(this).data('filename');
			if (name) {
				filenames.push(name);
			}
		});
		if (filenames.length === 0) {
			$batch.remove();
			return;
		}
		layer.confirm('Delete all audio files in this batch?', {
		  btn: ['Yes', 'No'],
		  title:false
		}, function() {
		  $.ajax({
			url: '/delete_wavs_batch',
			type: 'POST',
			data: { filenames: filenames.join(',') },
			success: function(response) {
			  if (response.code === 0) {
				$batch.remove();
				layer.alert('Batch deleted successfully', {title: false});
			  } else {
				layer.alert('Batch delete failed: ' + response.msg, {title: false});
			  }
			},
			error: function(xhr, status, error) {
			  layer.alert('Error: ' + error, {title: false});
			}
		  });
		});
	  });
      
    // Individual Delete
    $(document).on('click', '.delete-wav-btn', function() {
        // Find closest audio-item
		var $item = $(this).closest('.audio-item');
		var filename = $item.data('filename');
		if (!filename) { return; }
		
		layer.confirm('Delete this audio file?', {
		  btn: ['Yes', 'No'],
		  title: false
		}, function() {
		  $.ajax({
			url: '/delete_wav',
			type: 'POST',
			data: { filename: filename },
			success: function(response) {
			  if (response.code === 0) {
				$item.remove();
				layer.alert('Deleted successfully', {title: false});
			  } else {
				layer.alert('Delete failed: ' + response.msg, {title: false});
			  }
			},
			error: function(xhr, status, error) {
			  layer.alert('Error: ' + error, {title: false});
			}
		  });
		});
	});

});
</script>
</body>
</html>
